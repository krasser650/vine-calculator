let unitOfSugar=!0,isSimplifiedCalculationSystem=!1,collapsed=!0,isSaveHistory=!1;function showToast(e,t="info"){const s=document.getElementById("toastContainer");let l="bg-primary";"success"===t&&(l="bg-success"),"warning"===t&&(l="bg-warning text-dark"),"danger"===t&&(l="bg-danger");const n=document.createElement("div");n.className=`toast align-items-center text-white ${l} border-0`,n.role="alert",n.ariaLive="assertive",n.ariaAtomic="true",n.innerHTML=`\n    <div class="d-flex">\n      <div class="toast-body">${e}</div>\n      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>\n    </div>\n  `,s.appendChild(n);new bootstrap.Toast(n,{delay:3e3}).show(),n.addEventListener("hidden.bs.toast",()=>n.remove())}function calculateCU(){resetResult();let e=parseFloat(document.getElementById("sugarTarget").value),t=parseFloat(document.getElementById("alcoholTarget").value);if(isNaN(t)||t<0||isNaN(e)||e<0)return null;let s=document.getElementById("conservationUnit");const l=e+4.5*t;return l<80?(s.textContent="Кількість CU : ",s.textContent+=l.toFixed(2),s.style.color="red"):(s.textContent="Кількість CU : ",s.textContent+=l.toFixed(2),s.style.color="green"),{A_t:t/100,S_t:10*e}}function calcResult(){let e,t=Number(10*document.getElementById("S0").value),s=Number(document.getElementById("V0").value),l=Number(document.getElementById("As").value/100),n=Number(10*document.getElementById("Ss").value),a=calculateCU();if(!a||[s,t,l].some(e=>isNaN(e)||e<=0)||isNaN(n)||n<0)return void resetResultBox();unitOfSugar?e=(t/10+269.55213512)/.26678527537:(e=t/10,t=10*(.26678527537*t/10-269.55213512));let o=a.A_t,i=a.S_t,r=document.getElementById("resultBox"),d=l-o-(i-n)/1600;if(Math.abs(d)<1e-6)return r.className="alert alert-danger",void(r.textContent="Помилка: некоректні параметри (ділення на 0)");let c=(i*(l-o)+(o-t/1600)*(i-n))/d,u=(t-c)/1600,m=1e3*(.001*e-100*u/131.25),b=s*(o-u)/(l-o),p=s*(i-c)/(n-i),v=(b+p)/2,g=Math.abs(b-p)/v*100,y="alert-info",x="#198754",S="";g>10?(y="alert-danger",x="#dc3545",S=`Різниця між розрахунком по спирту та цукру: ${g.toFixed(1)}% (неузгоджено!)`):g>5&&(y="alert-warning",x="#ffc107",S=`Різниця між розрахунком по спирту та цукру: ${g.toFixed(1)}% (увага)`);let f=`<div class="progress mb-2" style="height: 8px;"> <div class="progress-bar" role="progressbar"\n      style="width: ${Math.min(g,100)}%; background-color: ${x};"></div>\n    </div>\n  `;if([c,u,v].some(e=>isNaN(e)||e<=0)||!unitOfSugar&&(isNaN(m)||m<=0))return r.className="alert alert-danger",void(r.textContent="Помилка: некоректні параметри!");let h=unitOfSugar?`<b>Початкова густина сусла:</b> ${e.toFixed(1)} г/л <br>\n    <b>Об'єм AM:</b> ${v.toFixed(2)} л (по спирту: ${b.toFixed(2)} л, по цукру: ${p.toFixed(2)} л)<br>\n    <b>Момент спиртування:</b>  цукор ≈ ${(c/10).toFixed(1)} г/100см<sup>3</sup>, (густина : ${m.toFixed(1)} г/л)<br>\n    <b>Спиртуозність сусла на момент спиртування:</b> ${(100*u).toFixed(2)} об. %<br>\n    ${S}`:`<b>Початкова цукристість сусла:</b> ${(.1*t).toFixed(2)} г/100см<sup>3</sup><br>\n    <b>Об'єм AM:</b> ${v.toFixed(2)} л (по спирту: ${b.toFixed(2)} л, по цукру: ${p.toFixed(2)} л)<br>\n    <b>Момент спиртування:</b>  густина ≈ ${m.toFixed(1)} г/л (цукор : ${(c/10).toFixed(2)} г/100см<sup>3</sup>)<br>\n    <b>Спиртуозність сусла на момент спиртування:</b> ${(100*u).toFixed(2)} об. %<br>\n    ${S}`;if(r.className=`alert ${y}`,r.innerHTML=f+h,isSaveHistory){const a={addVolume:v,sugarMoment:c,densityMoment:m,alcMoment:u},r=document.getElementById("saveCalcBtn");r.classList.remove("d-none"),r.onclick=()=>{addToHistory({V0:s,S0:t,D0:e,As:l,Ss:n,A_t:o,S_t:i},a),showToast("✅ Розрахунок сбережено","success");const r=document.getElementById("flush-collapseSix");new bootstrap.Collapse(r,{show:!0});r.scrollIntoView({behavior:"smooth"})}}}const HISTORY_LIMIT=5;function showAccordionItemHistory(){let e=document.getElementById("history-item_id");isSaveHistory&&e?e.classList.add("d-none"):e.classList.remove("d-none"),isSaveHistory=!isSaveHistory,calcResult()}function getHistory(){return JSON.parse(localStorage.getItem("calcHistory")||"[]")}function saveHistory(e){localStorage.setItem("calcHistory",JSON.stringify(e))}function addToHistory(e,t){let s=getHistory(),l={inputs:e,result:t,timestamp:Date.now()};s.unshift(l),s.length>HISTORY_LIMIT&&(s=s.slice(0,HISTORY_LIMIT)),saveHistory(s),renderHistory()}function renderHistory(){let e=getHistory(),t=document.getElementById("historyBox");0!==e.length?t&&(t.innerHTML="",unitOfSugar?e.forEach((e,s)=>{let l=e.inputs,n=e.result,a=new Date(e.timestamp).toLocaleString(),o=document.createElement("div");o.innerHTML=[`<div class="card  text-bg-light">\n                       <div class="card-header">\n                         <div class="date">\n                            <small><b>${a}</b></small>\n                            <button type="button" class="btn-close" aria-label="Close" onclick="deleteFromHistory(${s})"></button>\n                         </div>\n                       </div>\n\n                       <div class="card-body">\n                         <small class="desc"><b>Початкові дані:</b></small><br>\n                         <small><b>At:</b> ${(100*l.A_t).toFixed(1)} об.% | <b>St:</b> ${(l.S_t/10).toFixed(1)} г/100см<sup>3</sup></small> |\n                         <small><b>V0:</b> ${l.V0} л | <b>S0:</b> ${(l.S0/10).toFixed(1)} г/100см<sup>3</sup></small> |\n                         <small><b>As:</b> ${(100*l.As).toFixed(1)} об.% | <b>Ss:</b> ${(l.Ss/10).toFixed(1)} г/100см<sup>3</sup></small><br>\n                       </div>\n\n                       <div class="card-footer text-bg-warning">\n                         <small class="desc"><b>Результат розрахунку:</b></small><br>\n                         <small><b>Об'єм AM:</b> ${n.addVolume.toFixed(2)} л</small> |\n                         <small><b>Момент (цукор):</b> ${(n.sugarMoment/10).toFixed(1)} г/100см<sup>3</sup></small> |\n                         <small><b>Спирт. сусла:</b> ${(100*n.alcMoment).toFixed(2)} об.%</small>\n                       </div>\n                     </div>`].join(""),t.appendChild(o)}):e.forEach((e,s)=>{let l=e.inputs,n=e.result,a=new Date(e.timestamp).toLocaleString(),o=document.createElement("div");o.innerHTML=[`<div class="card text-bg-light">\n                      <div class="card-header">\n                        <div class="date">\n                            <small><b>${a}</b></small>\n                            <button type="button" class="btn-close" aria-label="Close" onclick="deleteFromHistory(${s})"></button>\n                        </div>\n                      </div>\n\n                      <div class="card-body">\n                        <small class="desc"><b>Початкові дані:</b></small><br>\n                        <small><b>At:</b> ${(100*l.A_t).toFixed(1)} об.% | <b>St:</b> ${(l.S_t/10).toFixed(1)} г/100см<sup>3</sup></small> |\n                        <small><b>V0:</b> ${l.V0} л | <b>D0:</b> ${l.D0.toFixed(1)} г/л</small> |\n                        <small><b>As:</b> ${(100*l.As).toFixed(1)} об.% | <b>Ss:</b> ${(l.Ss/10).toFixed(1)} г/100см<sup>3</sup></small><br>\n                      </div>\n\n                      <div class="card-footer text-bg-warning">\n                        <small class="desc"><b>Результат розрахунку:</b></small><br>\n                        <small><b>Об'єм AM:</b> ${n.addVolume.toFixed(2)} л</small> |\n                        <small><b>Момент (густина):</b> ${n.densityMoment.toFixed(1)} г/л</small> |\n                        <small><b>Спирт. сусла:</b> ${(100*n.alcMoment).toFixed(2)} об.%</small>\n                      </div>\n                    </div>`].join(""),t.appendChild(o)})):t.innerHTML='<p class="text-muted">Жодного запису не знайдено</p>'}function loadFromHistory(e){let t=getHistory()[e];t&&(document.getElementById("V0").value=t.inputs.V0,document.getElementById("S0").value=t.inputs.S0,document.getElementById("As").value=t.inputs.As,document.getElementById("Ss").value=t.inputs.Ss,document.getElementById("alcoholTarget").value=t.inputs.A_t,document.getElementById("sugarTarget").value=t.inputs.S_t,calcResult())}function deleteFromHistory(e){let t=getHistory();t.splice(e,1),saveHistory(t),renderHistory(),showToast("Запис видалено","warning")}function resetAll(){document.getElementById("calcForm").querySelectorAll("input").forEach(e=>{e.value="0",e.classList.remove("is-invalid","is-valid")}),resetResult()}function resetResult(){resetResultBox(),resetCU()}function resetResultBox(){let e=document.getElementById("resultBox");e.className="alert alert-secondary",e.textContent="Заповніть кроки 1 та 2",document.getElementById("saveCalcBtn").classList.add("d-none")}function resetCU(){let e=document.getElementById("conservationUnit");e.textContent="Кількість CU : не розраховано",e.style.color="black"}function changeMeasurementMethod(e){const t=document.getElementById("wortParameter_id");if(t){t.innerHTML=e?['<div class="parameter_id">\n                    <p class="desc">Додайте показники цукристості сусла, його кількість та\n                     спиртуозність <strong>спиртовмісного матеріалу</strong> (далі AМ)\n                            , яким плануєте проводити стабілізацію</p>\n                   <div class="mb-3">\n                   <label for="S0"class="form-label">Початкова цукристість сусла <code> (S0)</code>, г/100см<sup>3</sup></label>\n                <input type="number" class="form-control" id="S0" required value="0" min="15" max="35" step="0.5"\' +\n                \' placeholder="Початкова цукристість" oninput="resetResult()"></div>\n                </div>'].join(""):['<div id="parameter_id">\n                  <p class="desc">Додайте показники густини сусла, його кількість та\n                     спиртуозність <strong>спиртовмісного матеріалу</strong> (далі AМ)\n                            , яким плануєте проводити стабілізацію</p>\n                  <div class="mb-3">\n                  <label for="S0" class="form-label">Початкова густина сусла <code> (D0)</code>, г/л.</label>\n                <input type="number" class="form-control" id="S0" required value="0" min="1065" max="1200" step="5"\' +\n                \' placeholder="Початкова густина" oninput="resetResult()"></div>\n                </div>'].join("");let s=document.getElementById("S0");s.addEventListener("input",()=>{resetResult(),addEventForInput(s)}),resetResultBox(),unitOfSugar=e,renderHistory()}}function changeCalculationSystem(){if(isSimplifiedCalculationSystem){const e=document.getElementById("alcoholBlendSugar_id");e&&e.remove()}else;}function expandAccordion(){const e=document.getElementById("accordionId"),t=e.querySelectorAll(".accordion-collapse"),s=e.querySelectorAll("button");e&&t&&s&&(collapsed?(t.forEach(e=>{e.classList.add("show")}),s.forEach(e=>{e.classList.remove("collapsed"),e.setAttribute("aria-expanded","true")})):(t.forEach(e=>{e.classList.remove("show")}),s.forEach(e=>{e.classList.add("collapsed"),e.setAttribute("aria-expanded","false")})),collapsed=!collapsed)}function addEventForInput(e){let t=parseFloat(e.value);""===e.value||t<=0||isNaN(t)?(e.classList.add("is-invalid"),e.classList.remove("is-valid")):(e.classList.add("is-valid"),e.classList.remove("is-invalid")),"alcoholTarget"!==e.id&&"sugarTarget"!==e.id||calculateCU(),Array.from(document.querySelectorAll("#calcForm input")).every(e=>""!==e.value&&parseFloat(e.value)>=0&&!isNaN(parseFloat(e.value)))&&calcResult()}document.addEventListener("DOMContentLoaded",()=>{renderHistory()}),document.querySelectorAll("#calcForm input").forEach(e=>{e.addEventListener("input",()=>{resetResult(),addEventForInput(e)})});const tooltipTriggerList=document.querySelectorAll('[data-bs-toggle="tooltip"]'),tooltipList=[...tooltipTriggerList].map(e=>new bootstrap.Tooltip(e));
