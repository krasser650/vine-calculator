let isHydrometer=!0,isSimplifiedCalculationSystem=!1,collapsed=!0,isSaveHistory=!1;function showToast(e,t="info"){const s=document.getElementById("toastContainer");let l="bg-primary";"success"===t&&(l="bg-success"),"warning"===t&&(l="bg-warning text-dark"),"danger"===t&&(l="bg-danger");const n=document.createElement("div");n.className=`toast align-items-center text-white ${l} border-0`,n.role="alert",n.ariaLive="assertive",n.ariaAtomic="true",n.innerHTML=`\n    <div class="d-flex">\n      <div class="toast-body">${e}</div>\n      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>\n    </div>\n  `,s.appendChild(n);new bootstrap.Toast(n,{delay:3e3}).show(),n.addEventListener("hidden.bs.toast",()=>n.remove())}function calculateCU(){resetResult();let e=parseFloat(document.getElementById("sugarTarget").value),t=parseFloat(document.getElementById("alcoholTarget").value),s=document.getElementById("alertCuBox");if(isNaN(t)||isNaN(e))return s.classList.add("none-d"),null;if(t>35||e>35||t<0||e<0)return s.innerHTML="<b>Зверніть увагу</b>, вхідні параметри мають межі :<br>\n        цукристість (1-35) г/100 см<sup>3</sup>, спиртуозність (1-35) об.% ",s.classList.remove("none-d"),null;s.classList.add("none-d");let l=document.getElementById("conservationUnit");const n=e+4.5*t;return n<80?(l.textContent="Кількість CU : ",l.textContent+=n.toFixed(2),l.style.color="red"):(l.textContent="Кількість CU : ",l.textContent+=n.toFixed(2),l.style.color="green"),{A_t:t/100,S_t:10*e}}function calcResult(){let e,t=Number(10*document.getElementById("S0").value),s=Number(document.getElementById("V0").value),l=Number(document.getElementById("As").value/100),n=Number(10*document.getElementById("Ss").value),o=calculateCU();if(!o||[s,t,l].some(e=>isNaN(e)||e<=0)||isNaN(n)||n<0)return void resetResultBox();isHydrometer?e=1e3*densityToSugar.inv(t/10):(e=t/10,t=Math.round(100*densityToSugar.f(.001*e))/100*10,console.log(t));let a=o.A_t,i=o.S_t,d=document.getElementById("resultBox"),r=l-a-(i-n)/1690;if(Math.abs(r)<1e-6)return d.className="alert alert-danger",void(d.textContent="Помилка: некоректні параметри (ділення на 0)");let c=(i*(l-a)+(a-t/1690)*(i-n))/r,u=(t-c)/1690,m=1e3*(.001*e-100*u/131.25),v=s*(a-u)/(l-a),b=s*(i-c)/(n-i),p=(v+b)/2,y=Math.abs(v-b)/p*100,g="alert-primary",x="#198754",S="";y>10?(g="alert-danger",x="#dc3545",S=`Різниця між розрахунком по спирту та цукру: ${y.toFixed(1)}% (неузгоджено!)`):y>5&&(g="alert-warning",x="#ffc107",S=`Різниця між розрахунком по спирту та цукру: ${y.toFixed(1)}% (увага)`);let f=`<div class="progress mb-2" style="height: 8px;"> <div class="progress-bar" role="progressbar"\n      style="width: ${Math.min(y,100)}%; background-color: ${x};"></div>\n    </div>\n  `;if([c,u,p].some(e=>isNaN(e)||e<=0)||!isHydrometer&&(isNaN(m)||m<=0))return d.className="alert alert-danger",void(d.textContent="Помилка: некоректні параметри!");let h=isHydrometer?`<div class="px-2">\n            <b>РЕЗУЛЬТАТ:</b>\n            <div class="row">\n                <div class="col-sm-4">Об'єм AM</div>\n                <div class="col-sm-7 result result2"><b>${p.toFixed(2)}</b> л (по спирту: ${v.toFixed(2)} л, по цукру: ${b.toFixed(2)} л)</div>\n            </div><br>\n             <b>МОМЕНТ ВНЕСЕННЯ:</b>\n            <div class="row">\n                <div class="col-sm-4">Цукристість</div>\n                <div class="col-sm-7 result result2"><b>${(c/10).toFixed(2)}</b> г/100см<sup>3</sup></div>\n            </div>\n            <div class="row">\n                <div class="col-sm-4">Густина</div>\n                <div class="col-sm-7 result result2"><b>${m.toFixed(1)}</b> г/л</div>\n            </div>\n            <hr class="separator">\n            <b>ДОДАТКОВО:</b>\n            <div class="row">\n                <div class="col-sm-4">Початкова густина</div>\n                <div class="col-sm-7 result result2"><b>${e.toFixed(1)}</b> г/л </div>\n            </div>\n             <div class="row">\n                <div class="col-sm-4">Спиртуозність сусла на момент спиртування</div>\n                <div class="col-sm-7 result result2"><b>${(100*u).toFixed(2)}</b> об. %</div>\n             </div>\n        </div>`:`<div class="px-2">\n            <b>РЕЗУЛЬТАТ:</b>\n            <div class="row">\n                <div class="col-sm-4">Об'єм AM</div>\n                <div class="col-sm-7 result result2"><b>${p.toFixed(2)}</b> л (по спирту: ${v.toFixed(2)} л, по цукру: ${b.toFixed(2)} л)</div>\n            </div>\n            <div class="row">\n                <div class="col-sm-4">Момент спиртування</div>\n                <div class="col-sm-7 result result2">густина : <b>${m.toFixed(1)}</b> г/л (цукор : <b>${(c/10).toFixed(2)}</b> г/100см<sup>3</sup>)</div>\n            </div>\n            <hr class="separator">\n            <b>ДОДАТКОВО:</b>\n             <div class="row">\n                <div class="col-sm-4">Початкова цукристість</div>\n                <div class="col-sm-7 result result2"><b>${(.1*t).toFixed(2)}</b> г/100см<sup>3</sup></div>\n             </div>\n             <div class="row">\n                <div class="col-sm-4">Спиртуозність сусла на момент спиртування</div>\n                <div class="col-sm-7 result result2"><b>${(100*u).toFixed(2)}</b> об. %</div>\n             </div>\n        </div>`;if(d.className=`alert ${g}`,d.innerHTML=f+h,isSaveHistory){const o={addVolume:p,sugarMoment:c,densityMoment:m,alcMoment:u},d=document.getElementById("saveCalcBtn");d.classList.remove("d-none"),d.onclick=()=>{addToHistory({V0:s,S0:t,D0:e,As:l,Ss:n,A_t:a,S_t:i},o),showToast("✅ Розрахунок сбережено","success");const d=document.getElementById("flush-collapseSix");new bootstrap.Collapse(d,{show:!0});d.scrollIntoView({behavior:"smooth"})}}}const HISTORY_LIMIT=5;function showAccordionItemHistory(){let e=document.getElementById("history-item_id");isSaveHistory&&e?e.classList.add("d-none"):e.classList.remove("d-none"),isSaveHistory=!isSaveHistory,calcResult()}function getHistory(){return JSON.parse(localStorage.getItem("calcHistory")||"[]")}function saveHistory(e){localStorage.setItem("calcHistory",JSON.stringify(e))}function addToHistory(e,t){let s=getHistory(),l={inputs:e,result:t,timestamp:Date.now()};s.unshift(l),s.length>HISTORY_LIMIT&&(s=s.slice(0,HISTORY_LIMIT)),saveHistory(s),renderHistory()}function renderHistory(){let e=getHistory(),t=document.getElementById("historyBox");0!==e.length?t&&(t.innerHTML="",isHydrometer?e.forEach((e,s)=>{let l=e.inputs,n=e.result,o=new Date(e.timestamp).toLocaleString(),a=document.createElement("div");a.innerHTML=[`<div class="card  mt-3">\n                       <div class="card-header">\n                         <div class="date">\n                            <small>${o}</small>\n                            <button type="button" class="btn-close" aria-label="Close" onclick="deleteFromHistory(${s})"></button>\n                         </div>\n                       </div>\n\n                       <div class="card-body">\n                         Початкові дані :<br>\n                         <small><b>At:</b> ${(100*l.A_t).toFixed(1)} об.% | <b>St:</b> ${(l.S_t/10).toFixed(1)} г/100см<sup>3</sup></small> |\n                         <small><b>V0:</b> ${l.V0} л | <b>S0:</b> ${(l.S0/10).toFixed(1)} г/100см<sup>3</sup></small> |\n                         <small><b>As:</b> ${(100*l.As).toFixed(1)} об.% | <b>Ss:</b> ${(l.Ss/10).toFixed(1)} г/100см<sup>3</sup></small><br>\n                       </div>\n\n                       <div class="card-footer">\n                         <small class="desc"><b>Результат розрахунку:</b></small><br>\n                         <small><b>Об'єм AM:</b> ${n.addVolume.toFixed(2)} л</small> |\n                         <small><b>Момент (цукор):</b> ${(n.sugarMoment/10).toFixed(1)} г/100см<sup>3</sup></small> |\n                         <small><b>Спирт. сусла:</b> ${(100*n.alcMoment).toFixed(2)} об.%</small>\n                       </div>\n                     </div>`].join(""),t.appendChild(a)}):e.forEach((e,s)=>{let l=e.inputs,n=e.result,o=new Date(e.timestamp).toLocaleString(),a=document.createElement("div");a.innerHTML=[`<div class="card mt-3">\n                      <div class="card-header">\n                        <div class="date">\n                            <small>${o}</small>\n                            <button type="button" class="btn-close" aria-label="Close"\n                            onclick="deleteFromHistory(${s})"></button>\n                        </div>\n                      </div>\n\n                      <div class="card-body">\n                        Початкові дані :<br>\n                        <small><b>At:</b> ${(100*l.A_t).toFixed(1)} об.% | <b>St:</b> ${(l.S_t/10).toFixed(1)} г/100см<sup>3</sup></small> |\n                        <small><b>V0:</b> ${l.V0} л | <b>D0:</b> ${l.D0.toFixed(1)} г/л</small> |\n                        <small><b>As:</b> ${(100*l.As).toFixed(1)} об.% | <b>Ss:</b> ${(l.Ss/10).toFixed(1)} г/100см<sup>3</sup></small><br>\n                      </div>\n\n                      <div class="card-footer">\n                        <small class="desc"><b>Результат розрахунку:</b></small><br>\n                        <small><b>Об'єм AM:</b> ${n.addVolume.toFixed(2)} л</small> |\n                        <small><b>Момент (густина):</b> ${n.densityMoment.toFixed(1)} г/л</small> |\n                        <small><b>Спирт. сусла:</b> ${(100*n.alcMoment).toFixed(2)} об.%</small>\n                      </div>\n                    </div>`].join(""),t.appendChild(a)})):t.innerHTML='<p class="text-muted">Жодного запису не знайдено</p>'}function loadFromHistory(e){let t=getHistory()[e];t&&(document.getElementById("V0").value=t.inputs.V0,document.getElementById("S0").value=t.inputs.S0,document.getElementById("As").value=t.inputs.As,document.getElementById("Ss").value=t.inputs.Ss,document.getElementById("alcoholTarget").value=t.inputs.A_t,document.getElementById("sugarTarget").value=t.inputs.S_t,calcResult())}function deleteFromHistory(e){let t=getHistory();t.splice(e,1),saveHistory(t),renderHistory(),showToast("Запис видалено","warning")}function resetAll(){document.getElementById("calcForm").querySelectorAll("input").forEach(e=>{e.value="0",e.classList.remove("is-invalid","is-valid")}),resetResult()}function resetResult(){resetResultBox(),resetCU()}function resetResultBox(){let e=document.getElementById("resultBox");e.className="alert alert-secondary",e.textContent="Заповніть кроки 1 та 2",document.getElementById("saveCalcBtn").classList.add("d-none")}function resetCU(){let e=document.getElementById("conservationUnit");e.textContent="Кількість CU : не розраховано",e.style.color="black"}function changeMeasurementMethod(e){const t=document.getElementById("wortParameter_id");if(t){t.innerHTML=e?['<div class="parameter_id">\n                    <p class="desc">Додайте показники цукристості сусла, його кількість та\n                     спиртуозність <strong>спиртовмісного матеріалу</strong> (далі AМ)\n                            , яким плануєте проводити стабілізацію</p>\n                   <div class="mb-3">\n                   <label for="S0" class="form-label">Початкова цукристість сусла <code> (S0)</code>, г/100см<sup>3</sup></label>\n                <input type="number" class="form-control" id="S0" required value="0" min="15" max="35" step="0.5"\' +\n                \' placeholder="Початкова цукристість" oninput="resetResult()"></div>\n                </div>'].join(""):['<div id="parameter_id">\n                  <p class="desc">Додайте показники густини сусла, його кількість та\n                     спиртуозність <strong>спиртовмісного матеріалу</strong> (далі AМ)\n                            , яким плануєте проводити стабілізацію</p>\n                  <div class="mb-3">\n                  <label for="S0" class="form-label">Початкова густина сусла <code> (D0)</code>, г/л.</label>\n                <input type="number" class="form-control" id="S0" required value="0" min="1000" max="1200" step="5"\' +\n                \' placeholder="Початкова густина" oninput="resetResult()"></div>\n                </div>'].join("");let s=document.getElementById("S0");s.addEventListener("input",()=>{resetResult(),addEventForInput(s)}),resetResultBox(),isHydrometer=e,renderHistory()}}function changeCalculationSystem(){if(isSimplifiedCalculationSystem){const e=document.getElementById("alcoholBlendSugar_id");e&&e.remove()}else;}function expandAccordion(){const e=document.getElementById("accordionId"),t=e.querySelectorAll(".accordion-collapse"),s=e.querySelectorAll("button");e&&t&&s&&(collapsed?(t.forEach(e=>{e.classList.add("show")}),s.forEach(e=>{e.classList.remove("collapsed"),e.setAttribute("aria-expanded","true")})):(t.forEach(e=>{e.classList.remove("show")}),s.forEach(e=>{e.classList.add("collapsed"),e.setAttribute("aria-expanded","false")})),collapsed=!collapsed)}function addEventForInput(e){validationInput(e),"alcoholTarget"!==e.id&&"sugarTarget"!==e.id||calculateCU(),Array.from(document.querySelectorAll("#calcForm input")).every(e=>""!==e.value&&parseFloat(e.value)>=0&&!isNaN(parseFloat(e.value)))&&calcResult()}document.addEventListener("DOMContentLoaded",()=>{renderHistory()}),document.querySelectorAll("#calcForm input").forEach(e=>{e.addEventListener("input",()=>{resetResult(),addEventForInput(e)})});const tooltipTriggerList=document.querySelectorAll('[data-bs-toggle="tooltip"]'),tooltipList=[...tooltipTriggerList].map(e=>new bootstrap.Tooltip(e));